#!/bin/bash --login

#SBATCH -J Wiki_test_ngram_gemma_rescore
#SBATCH -a 1-672 # Change to the amount in the list
#SBATCH -p himem
#SBATCH -t 7-0

set -e  # optional: stop on error

# Load conda module
module load apps/binapps/anaconda3/2024.10

# Activate the environment
conda activate venv

# Define variables
CORPUS="Wiki"
DATA_TYPE="test"
MODEL_LOC="/mnt/hum01-home01/d34195bc/models/Llama-3.2-3B"

DATA_DIR="/mnt/hum01-home01/d34195bc/av_datasets/paraphrase_examples/${CORPUS}-${DATA_TYPE}"
SAVE_DIR="/mnt/hum01-home01/d34195bc/av_datasets/paraphrase_examples/${CORPUS}-${DATA_TYPE}-completed-llama"

# Input lists produced in step 1:
PROBLEM_DOC_LIST="/mnt/hum01-home01/d34195bc/av_datasets/${DATA_TYPE}/${CORPUS}/problem_doc_list.txt"

# ---- Select the Nth line from each list (N = SLURM_ARRAY_TASK_ID) ----
# Using awk with a variable for safety; exit after printing to avoid scanning whole file.
DOC_NAME=$(awk -v n="$SLURM_ARRAY_TASK_ID" 'NR==n {print; exit}' "$PROBLEM_DOC_LIST")
DATA_LOC="${DATA_DIR}/${DOC_NAME}.xlsx"

# Run top impostors on the Nth file from parascore folder
python -u /mnt/hum01-home01/d34195bc/projects/av_distributions/scripts/run_scoring_with_new_model.py \
    --data_loc "${DATA_LOC}" \
    --save_dir "${SAVE_DIR}" \
    --model_loc "${MODEL_LOC}"